<form class="{{cssClass}}" autocomplete="off">
  {{!-- Sheet Header --}}
  <header class="sheet-header">
    <div class="header-controls">
      {{!-- Zukus Cloud Sync Controls --}}
      {{#if isLoggedIn}}
        <span class="zukus-user" title="Logged in as {{userEmail}}">
          <i class="fas fa-user"></i>
        </span>
        {{#if isLinked}}
          <span class="zukus-linked" title="Synced with Zukus">
            <i class="fas fa-cloud"></i>
          </span>
          <button type="button" class="zukus-unlink" title="Unlink from Zukus">
            <i class="fas fa-unlink"></i>
          </button>
        {{else}}
          <button type="button" class="zukus-link" title="Link to Zukus character">
            <i class="fas fa-link"></i>
          </button>
        {{/if}}
        <button type="button" class="zukus-logout" title="Logout from Zukus">
          <i class="fas fa-sign-out-alt"></i>
        </button>
      {{else}}
        <button type="button" class="zukus-login" title="Login to Zukus to sync">
          <i class="fas fa-cloud"></i> Sync
        </button>
      {{/if}}

      {{!-- Import/Export Controls --}}
      <button type="button" class="import-character" title="Import character from JSON">
        <i class="fas fa-file-import"></i>
      </button>
      <button type="button" class="export-character" title="Export character to JSON">
        <i class="fas fa-file-export"></i>
      </button>
    </div>
    <img class="profile-img" src="{{actor.img}}" title="{{actor.name}}" data-edit="img"/>

    <div class="header-fields">
      <h1 class="charname">
        <input name="name" type="text" value="{{actor.name}}" placeholder="Character Name"/>
      </h1>
      <div class="level-display">
        {{localize "DND35ZUKUS.Level"}}: {{characterLevel}}
      </div>
    </div>

    <div class="header-stats">
      <div class="stat-box">
        <div class="stat-label">{{localize "DND35ZUKUS.HP"}}</div>
        <div class="stat-value">{{combat.hp.current}}/{{combat.hp.max}}</div>
      </div>
      <div class="stat-box" data-source-breakdown="ac">
        <div class="stat-label">{{localize "DND35ZUKUS.AC"}}</div>
        <div class="stat-value">{{combat.ac.total}}</div>
      </div>
      <div class="stat-box initiative-roll" data-source-breakdown="initiative">
        <div class="stat-label">{{localize "DND35ZUKUS.Initiative"}}</div>
        <div class="stat-value">{{combat.initiativeDisplay}}</div>
      </div>
    </div>
  </header>

  {{!-- Sheet Tabs --}}
  <nav class="sheet-tabs tabs" data-group="primary">
    <a class="item" data-tab="abilities">{{localize "DND35ZUKUS.Tabs.Abilities"}}</a>
    <a class="item" data-tab="combat">{{localize "DND35ZUKUS.Tabs.Combat"}}</a>
    <a class="item" data-tab="features">{{localize "DND35ZUKUS.Tabs.Features"}}</a>
  </nav>

  {{!-- Sheet Body --}}
  <section class="sheet-body">

    {{!-- Abilities Tab --}}
    <div class="tab abilities" data-group="primary" data-tab="abilities">
      <div class="abilities-grid">
        {{#each abilities as |ability|}}
        <div class="ability-card rollable" data-ability="{{ability.key}}" data-source-breakdown="abilities.{{ability.key}}">
          <div class="ability-label">{{ability.label}}</div>
          <div class="ability-scores">
            <input type="number"
                   class="ability-base-input"
                   name="system.abilities.{{ability.key}}.value"
                   value="{{ability.baseValue}}"
                   data-dtype="Number"
                   title="Base score"/>
            <span class="ability-total" title="Total score (with bonuses)">{{ability.score}}</span>
          </div>
          <div class="ability-modifier">{{ability.modifierDisplay}}</div>
        </div>
        {{/each}}
      </div>

      {{!-- Saving Throws --}}
      <h3>{{localize "DND35ZUKUS.Saves.Fortitude"}}, {{localize "DND35ZUKUS.Saves.Reflex"}}, {{localize "DND35ZUKUS.Saves.Will"}}</h3>
      <div class="saves-grid">
        {{#each saves as |save|}}
        <div class="save-item rollable" data-save="{{save.key}}" data-source-breakdown="saves.{{save.key}}">
          <span class="save-label">{{save.label}}</span>
          <span class="save-value">{{save.display}}</span>
        </div>
        {{/each}}
      </div>
    </div>

    {{!-- Combat Tab --}}
    <div class="tab combat" data-group="primary" data-tab="combat">
      <div class="combat-grid">
        <div class="combat-stat">
          <div class="stat-label">{{localize "DND35ZUKUS.HP"}}</div>
          <div class="stat-value">
            <input type="number" name="system.hp.value" value="{{combat.hp.current}}" data-dtype="Number" style="width: 50px"/>
            /
            <span>{{combat.hp.max}}</span>
          </div>
        </div>

        <div class="combat-stat" data-source-breakdown="ac">
          <div class="stat-label">{{localize "DND35ZUKUS.AC"}} (Total)</div>
          <div class="stat-value">{{combat.ac.total}}</div>
        </div>

        <div class="combat-stat" data-source-breakdown="touchAc">
          <div class="stat-label">Touch AC</div>
          <div class="stat-value">{{combat.ac.touch}}</div>
        </div>

        <div class="combat-stat" data-source-breakdown="flatFootedAc">
          <div class="stat-label">Flat-Footed AC</div>
          <div class="stat-value">{{combat.ac.flatFooted}}</div>
        </div>

        <div class="combat-stat" data-source-breakdown="bab">
          <div class="stat-label">{{localize "DND35ZUKUS.BAB"}}</div>
          <div class="stat-value">{{combat.babDisplay}}</div>
        </div>

        <div class="combat-stat" data-source-breakdown="grapple">
          <div class="stat-label">Grapple</div>
          <div class="stat-value">{{combat.grappleDisplay}}</div>
        </div>
      </div>

      {{!-- Attacks Section --}}
      <h3>Attacks</h3>
      <div class="attacks-section">
        {{#if attacks.length}}
        <div class="attack-list">
          {{#each attacks as |attack|}}
          <div class="attack-item" data-attack-index="{{attack.index}}">
            <div class="attack-info">
              <span class="attack-name">{{attack.name}}</span>
              <span class="attack-type">{{attack.typeLabel}}</span>
            </div>
            <div class="attack-stats">
              <div class="attack-bonus" data-source-breakdown="attacks.{{attack.index}}">
                <span class="stat-value">{{attack.attackBonusDisplay}}</span>
                <span class="stat-label">ATK</span>
              </div>
              <div class="attack-damage">
                <span class="stat-value">{{attack.damageDisplay}}</span>
                <span class="stat-label">DMG</span>
              </div>
            </div>
            <button type="button" class="attack-roll" data-attack-index="{{attack.index}}" title="Quick Roll">
              <i class="fas fa-dice-d20"></i>
            </button>
          </div>
          {{/each}}
        </div>
        {{else}}
        <p class="no-attacks">No weapons equipped</p>
        {{/if}}
      </div>

      {{!-- Character Classes (from CharacterBaseData) --}}
      <h3>Classes</h3>
      <div class="classes-section">
        {{#if classes.length}}
        <div class="class-list">
          {{#each classes as |cls|}}
          <div class="class-item">
            <span class="class-name">{{cls.name}}</span>
            <span class="class-level-wrapper">
              <label>Lvl</label>
              <input type="number"
                     class="class-level-input"
                     data-class-id="{{cls.id}}"
                     value="{{cls.level}}"
                     min="0"
                     max="20"/>
            </span>
            <span class="class-hitdie">(d{{cls.hitDie}})</span>
            <button type="button" class="add-class-level" data-class-id="{{cls.id}}" title="Add level in {{cls.name}}">
              <i class="fas fa-plus"></i>
            </button>
          </div>
          {{/each}}
        </div>
        {{/if}}

        {{!-- Available classes to add --}}
        <div class="available-classes">
          <label>Add Class:</label>
          <div class="class-buttons">
            {{#each availableClasses as |cls|}}
            <button type="button" class="add-class-level" data-class-id="{{cls.id}}" title="{{cls.description}}">
              <i class="fas fa-plus"></i> {{cls.name}} (d{{cls.hitDie}})
            </button>
            {{/each}}
          </div>
        </div>

        {{#if characterLevel}}
        <div class="level-controls">
          <button type="button" class="remove-level" title="Remove last level">
            <i class="fas fa-minus"></i> Remove Level
          </button>
        </div>
        {{/if}}
      </div>

      {{!-- Buffs from Core System --}}
      <h3>Active Buffs</h3>
      <div class="buffs-section">
        {{!-- Current buffs on character --}}
        {{#if currentBuffs.length}}
        <div class="buff-list">
          {{#each currentBuffs as |buff|}}
          <div class="buff-item {{#if buff.active}}active{{/if}}">
            <span class="buff-toggle toggle-buff" data-buff-id="{{buff.uniqueId}}" title="Toggle buff">
              {{#if buff.active}}
              <i class="fas fa-check-circle"></i>
              {{else}}
              <i class="far fa-circle"></i>
              {{/if}}
            </span>
            <span class="buff-name">{{buff.name}}</span>
            <span class="buff-description" title="{{buff.description}}">{{buff.description}}</span>
            <button type="button" class="remove-buff" data-buff-id="{{buff.uniqueId}}" title="Remove {{buff.name}}">
              <i class="fas fa-times"></i>
            </button>
          </div>
          {{/each}}
        </div>
        {{else}}
        <p class="no-buffs">No active buffs</p>
        {{/if}}

        {{!-- Available buffs to add --}}
        <div class="available-buffs">
          <label>Add Buff:</label>
          <div class="buff-buttons">
            {{#each availableBuffs as |buff|}}
            <button type="button" class="add-buff" data-buff-id="{{buff.id}}" title="{{buff.description}}">
              <i class="fas fa-plus"></i> {{buff.name}}
            </button>
            {{/each}}
          </div>
        </div>
      </div>
    </div>

    {{!-- Features Tab --}}
    <div class="tab features" data-group="primary" data-tab="features">
      <h3>Feats</h3>
      <div class="item-list feats-list">
        {{#each itemsByType.feats as |item|}}
        <div class="item" data-item-id="{{item._id}}">
          <span class="item-name">{{item.name}}</span>
          <span class="item-controls">
            <a class="item-edit" title="Edit"><i class="fas fa-edit"></i></a>
            <a class="item-delete" title="Delete"><i class="fas fa-trash"></i></a>
          </span>
        </div>
        {{/each}}
        <div class="item-create" data-type="feat">
          <a><i class="fas fa-plus"></i> Add Feat</a>
        </div>
      </div>
    </div>

  </section>
</form>
