---
alwaysApply: true
---
## ğŸ—ï¸ Arquitectura

### 3 Capas Principales

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Frontend (React + Vite)                â”‚
â”‚  Puerto: 5173                           â”‚
â”‚  - UI de ediciÃ³n de schemas/instancias  â”‚
â”‚  - EntityTypeEditor (recursivo)         â”‚
â”‚  - EntityInstanceEditor                 â”‚
â”‚  - EntitySelector (virtualizado)        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â”‚ HTTP REST API
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Backend (Bun Server)                   â”‚
â”‚  Puerto: 3001                           â”‚
â”‚  - API REST (/api/entity-types, etc)    â”‚
â”‚  - CRUD de schemas e instancias         â”‚
â”‚  - CORS habilitado                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â”‚ File I/O
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Storage (Archivos JSON)                â”‚
â”‚  visualPlayground/server/data/          â”‚
â”‚  â”œâ”€â”€ schemas/                           â”‚
â”‚  â”‚   â””â”€â”€ {typeName}.json               â”‚
â”‚  â””â”€â”€ entities/                          â”‚
â”‚      â””â”€â”€ {typeName}/                    â”‚
â”‚          â””â”€â”€ {entityId}.json            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ“ Estructura de Archivos

```
visualPlayground/
â”œâ”€â”€ server/                    # Backend
â”‚   â”œâ”€â”€ index.ts              # API REST principal
â”‚   â”œâ”€â”€ storage.ts            # Operaciones de archivo
â”‚   â”œâ”€â”€ types.ts              # Tipos del servidor
â”‚   â””â”€â”€ data/                 # Persistencia
â”‚       â”œâ”€â”€ schemas/          # Definiciones de tipos
â”‚       â”‚   â”œâ”€â”€ spell.json
â”‚       â”‚   â””â”€â”€ prueba.json
â”‚       â””â”€â”€ entities/         # Instancias por tipo
â”‚           â”œâ”€â”€ spell/        # 2790 archivos
â”‚           â””â”€â”€ prueba/
â”‚
â”œâ”€â”€ src/                      # Frontend
â”‚   â”œâ”€â”€ App.tsx              # Router principal
â”‚   â”œâ”€â”€ pages/
â”‚   â”‚   â”œâ”€â”€ Home.tsx
â”‚   â”‚   â”œâ”€â”€ EntityManagementPage.tsx  # â­ PÃ¡gina principal
â”‚   â”‚   â”œâ”€â”€ SpellSearchPage.tsx
â”‚   â”‚   â””â”€â”€ EntitySelectorsPage.tsx
â”‚   â”œâ”€â”€ components/
â”‚   â”‚   â”œâ”€â”€ entity-editor/
â”‚   â”‚   â”‚   â”œâ”€â”€ EntityTypeEditor.tsx     # â­ Editor de schemas (RECURSIVO)
â”‚   â”‚   â”‚   â””â”€â”€ EntityInstanceEditor.tsx # â­ Editor de instancias
â”‚   â”‚   â”œâ”€â”€ shared/
â”‚   â”‚   â”‚   â””â”€â”€ EntitySelector.tsx       # Selector virtualizado
â”‚   â”‚   â””â”€â”€ ui/              # Shadcn/ui components
â”‚   â”œâ”€â”€ lib/
â”‚   â”‚   â””â”€â”€ api.ts           # Cliente API REST
â”‚   â””â”€â”€ data/
â”‚       â”œâ”€â”€ allSpells.ts     # 2792 conjuros importados
â”‚       â””â”€â”€ spellSchema.ts   # Schema de conjuros
â”‚
â”œâ”€â”€ scripts/                  # Scripts de importaciÃ³n
â”‚   â”œâ”€â”€ convertSpells.ts     # conjuros.json â†’ allSpells.ts
â”‚   â””â”€â”€ importSpells.ts      # allSpells.ts â†’ server/data/
â”‚
â””â”€â”€ package.json             # âš ï¸ Usa pnpm lock
```

---

## ğŸ¯ EntityTypeEditor - Editor de Schemas (Componente Recursivo)

### CaracterÃ­sticas Principales

**Componente `FieldEditor` 100% Recursivo:**
- Se llama a sÃ­ mismo para campos `objectFields`
- Soporte para anidamiento infinito
- Padding dinÃ¡mico segÃºn profundidad: `Math.max(8, 16 - (depth * 4))px`

### Tipos de Campo Soportados

```typescript
type EntityFieldType = 
  | 'string'         // Texto simple
  | 'integer'        // NÃºmero entero
  | 'boolean'        // Verdadero/falso
  | 'string_array'   // Array de textos
  | 'integer_array'  // Array de nÃºmeros
  | 'reference'      // Referencias a otras entidades (requiere referenceType)
  | 'object'         // Objeto con campos anidados (usa objectFields)
  | 'object_array'   // Array de objetos (usa objectFields)
```

### Propiedades de Campo

```typescript
type EntityFieldDefinition = {
  name: string                    // Nombre del campo (snake_case automÃ¡tico)
  type: EntityFieldType           // Tipo del campo
  description?: string            // DescripciÃ³n opcional
  optional?: boolean              // Â¿Es opcional?
  nonEmpty?: boolean              // Â¿Requiere al menos un elemento? (arrays/refs)
  allowedValues?: (string|number)[] // Valores permitidos (enum)
  referenceType?: string          // Tipo de entidad referenciada (solo 'reference')
  objectFields?: EntityFieldDefinition[] // Campos anidados (solo 'object'/'object_array')
}
```

### Ejemplo de Schema Complejo

```json
{
  "typeName": "character",
  "description": "D&D Character",
  "fields": [
    {
      "name": "level",
      "type": "integer",
      "description": "Character level",
      "optional": false
    },
    {
      "name": "stats",
      "type": "object",
      "description": "Character statistics",
      "objectFields": [
        {
          "name": "abilities",
          "type": "object",
          "objectFields": [
            {
              "name": "strength",
              "type": "object",
              "objectFields": [
                { "name": "base", "type": "integer" },
                { "name": "modifier", "type": "integer" }
              ]
            }
          ]
        }
      ]
    },
    {
      "name": "spells_known",
      "type": "reference",
      "referenceType": "spell",
      "optional": true
    }
  ]
}
```

### VisualizaciÃ³n por Profundidad

- **Nivel 0** (raÃ­z): Fondo `bg-card/50`, padding 16px
- **Nivel 1+**: Fondo `bg-muted/30`, padding reducido
- **Badge** "Nivel X" en campos anidados
- **Borde izquierdo** con `border-primary/30` para indicar anidamiento

### Controles Disponibles en Cada Nivel

Todos los campos (sin importar la profundidad) tienen:
- âœ… Selector de tipo completo (todos los 8 tipos)
- âœ… Input de nombre (slugificado automÃ¡tico)
- âœ… Input de descripciÃ³n
- âœ… Toggle opcional/requerido
- âœ… Toggle nonEmpty (si aplica)
- âœ… Input de valores permitidos (si aplica)
- âœ… Selector de referenceType (si es reference)
- âœ… Botones mover arriba/abajo
- âœ… BotÃ³n eliminar
- âœ… **BotÃ³n "AÃ±adir campo"** para objectFields

---

## ğŸ“ EntityInstanceEditor - Editor de Instancias

### Renderizado por Tipo

El editor renderiza campos dinÃ¡micamente segÃºn su tipo:

#### Campos Simples
- **String**: `<Input>` o `<Select>` (si tiene allowedValues)
- **Integer**: `<Input type="number">` o `<Select>` (si tiene allowedValues)
- **Boolean**: `<Switch>`

#### Arrays
- **Con allowedValues**: Checkboxes mÃºltiples con badges
- **Sin allowedValues**: Lista dinÃ¡mica con +/- botones

#### Referencias (`ReferenceField`)
```typescript
// Filtrado automÃ¡tico por referenceType
const filteredEntities = availableEntities.filter(
  e => !referenceType || e.entityType === referenceType
)

// Si hay entidades disponibles
<EntitySelector 
  selectedIds={refs}
  entities={filteredEntities}
  entityType={referenceType}
/>

// Fallback: inputs manuales de IDs
```

#### Objetos (`ObjectField`)
```typescript
// Renderiza cada campo del objeto recursivamente
<div className="border rounded-lg p-3 bg-muted/20">
  {objectFields.map(nestedField => (
    <FieldRenderer 
      field={nestedField}
      value={value[nestedField.name]}
      onChange={(v) => onChange({...value, [nestedField.name]: v})}
      availableEntities={availableEntities} // â­ Pasa entidades disponibles
    />
  ))}
</div>
```

#### Arrays de Objetos (`ObjectArrayField`)
```typescript
// BotÃ³n para aÃ±adir nuevos objetos
// Cada elemento usa ObjectField internamente
arr.map((item, index) => (
  <ObjectField 
    value={item}
    onChange={(v) => handleItemChange(index, v)}
  />
))
```

### Referencias Dentro de Objetos Anidados

**Â¡Funcionan perfectamente!** El `availableEntities` se pasa recursivamente:

```typescript
// En ObjectField
<FieldRenderer 
  field={nestedField}
  availableEntities={availableEntities} // â­ Se propaga
/>

// LlegarÃ¡ a ReferenceField que usa EntitySelector
```

---

## ğŸ” EntitySelector - Selector Virtualizado

### CaracterÃ­sticas

- **VirtualizaciÃ³n**: Usa `@tanstack/react-virtual` para manejar miles de entidades
- **BÃºsqueda**: Filtrado en tiempo real por nombre
- **Filtrado por tipo**: Opcional con `entityType`
- **SelecciÃ³n mÃºltiple o simple**: Controlado por `multiple` prop
- **Badges de metadatos**: category, level, school, etc.

### Uso

```typescript
<EntitySelector
  selectedIds={['spell-1', 'spell-2']}
  onChange={(ids) => setSelected(ids)}
  entities={allEntities}
  entityType="spell"      // Opcional: filtrar por tipo
  multiple={true}
  placeholder="Buscar conjuros..."
  maxHeight={320}
/>
```

---

## ğŸ”„ API REST

### Entity Types (Schemas)

```
GET    /api/entity-types              # Listar todos
POST   /api/entity-types              # Crear
GET    /api/entity-types/:typeName    # Obtener uno
PUT    /api/entity-types/:typeName    # Actualizar (con rename si cambia typeName)
DELETE /api/entity-types/:typeName    # Eliminar (+ todas sus instancias)
```

### Entities (Instances)

```
GET    /api/entities/:typeName        # Listar todas del tipo
POST   /api/entities/:typeName        # Crear
GET    /api/entities/:typeName/:id    # Obtener una
PUT    /api/entities/:typeName/:id    # Actualizar
DELETE /api/entities/:typeName/:id    # Eliminar
```

### Storage Backend

**Operaciones de Archivo** (`storage.ts`):
```typescript
// Schemas
saveSchema(schema)              â†’ schemas/{typeName}.json
getSchema(typeName)             â†’ Schema | null
getAllSchemas()                 â†’ Schema[]
deleteSchema(typeName)          â†’ Borra schema + entities dir
renameSchema(old, new)          â†’ Renombra + migra entidades

// Entities
saveEntity(typeName, entity)    â†’ entities/{typeName}/{id}.json
getEntity(typeName, id)         â†’ Entity | null
getAllEntities(typeName)        â†’ Entity[]
deleteEntity(typeName, id)      â†’ Borra archivo
```

---

## ğŸ¨ Flujo de Trabajo TÃ­pico

### 1. Crear un Tipo de Entidad

```bash
1. Navegar a http://localhost:5173/entity-management
2. Click "Nuevo tipo"
3. Definir typeName, description
4. AÃ±adir campos personalizados:
   - Configurar nombre, tipo, descripciÃ³n
   - Marcar como opcional si es necesario
   - AÃ±adir allowedValues si aplica
   - Para references: especificar referenceType
   - Para objects: aÃ±adir objectFields (Â¡recursivo!)
5. Guardar â†’ Crea schemas/{typeName}.json
```

### 2. Crear Instancia de la Entidad

```bash
1. Seleccionar tipo en sidebar
2. Click "Nueva instancia"
3. Modal con EntityInstanceEditor:
   - Campos base: id, name, description, tags
   - Campos personalizados segÃºn schema
   - Referencias: usar EntitySelector
   - Objetos: formularios anidados
4. Guardar â†’ Crea entities/{typeName}/{id}.json
```

### 3. Editar/Eliminar

- **Editar Schema**: BotÃ³n edit en SchemaCard â†’ Abre EntityTypeEditor
- **Editar Instancia**: BotÃ³n edit en InstanceRow â†’ Modal con editor
- **Eliminar Schema**: BotÃ³n delete â†’ Confirmar â†’ Borra schema + todas instancias
- **Eliminar Instancia**: BotÃ³n delete â†’ Confirmar â†’ Borra archivo
- **Duplicar Instancia**: BotÃ³n copy â†’ Crea copia con `-copy-{timestamp}`

---

## ğŸ“Š Estructura de Datos

### Schema Guardado

```json
{
  "typeName": "spell",
  "description": "D&D 3.5 Spell",
  "addons": ["searchable", "taggable"],
  "fields": [
    {
      "name": "level",
      "type": "integer",
      "description": "Spell level (0-9)",
      "optional": false
    },
    {
      "name": "school",
      "type": "string",
      "description": "Magic school"
    }
  ]
}
```

### Instancia Guardada

```json
{
  "id": "fireball",
  "entityType": "spell",
  "name": "Fireball",
  "description": "A ball of fire...",
  "tags": ["combat", "evocation"],
  
  "level": 3,
  "school": "Evocation"
}
```

---

## ğŸ› ï¸ Scripts de ImportaciÃ³n

### convertSpells.ts

Convierte `conjuros.json` (formato de compendio) a `allSpells.ts` (array tipado):

```bash
cd visualPlayground
pnpm run scripts/convertSpells.ts
```

**Resultado**: `src/data/allSpells.ts` con 2792 conjuros

### importSpells.ts

Importa `allSpells.ts` al sistema de persistencia:

```bash
cd visualPlayground
pnpm run scripts/importSpells.ts
```

**Resultado**: 
- `server/data/schemas/spell.json`
- `server/data/entities/spell/*.json` (2790 archivos)

---

## ğŸ› Debugging

### Backend no responde
```bash
# Verificar si el servidor estÃ¡ corriendo
lsof -ti:3001

# Iniciar servidor backend
cd visualPlayground
pnpm run server
```

### Frontend no compila
```bash
# Verificar errores en consola
cd visualPlayground
pnpm dev

# Limpiar y reinstalar
rm -rf node_modules
pnpm install
```

### Entidades no cargan
1. Verificar que el backend estÃ© corriendo (puerto 3001)
2. Abrir Network tab en DevTools
3. Verificar que las llamadas a `/api/entity-types` devuelvan 200
4. Verificar archivos en `server/data/`

---

## âš ï¸ Limitaciones Conocidas

1. **No hay validaciÃ³n Zod en frontend**: La validaciÃ³n solo ocurre en backend
2. **Archivos JSON planos**: No hay base de datos real (trade-off: simplicidad)
3. **Sin transacciones**: Operaciones no son atÃ³micas
4. **Sin bÃºsqueda fulltext**: Solo filtrado por nombre/ID en memoria
5. **Sin Ã­ndices**: Cargar todas las entidades puede ser lento con >10k instancias

---

## ğŸ¯ Mejores PrÃ¡cticas

### Al Crear Schemas

- âœ… Usa nombres descriptivos en `snake_case`
- âœ… AÃ±ade `description` a todos los campos
- âœ… Marca campos como `optional` solo si realmente lo son
- âœ… Usa `allowedValues` para campos con opciones limitadas
- âœ… Especifica `referenceType` en todas las referencias
- âœ… Usa `nonEmpty: true` para arrays/referencias requeridas

### Al Crear Instancias

- âœ… Usa IDs Ãºnicos y descriptivos (slug format)
- âœ… AÃ±ade `description` para contexto
- âœ… Usa `tags` para categorizaciÃ³n y bÃºsqueda
- âœ… Verifica referencias antes de guardar
- âœ… Prueba la instancia antes de duplicarla masivamente

### Al Trabajar con Objetos Anidados

- âœ… MantÃ©n la anidaciÃ³n a 2-3 niveles mÃ¡ximo
- âœ… Usa nombres claros para campos anidados
- âœ… Considera si un objeto deberÃ­a ser una entidad separada con referencia
- âœ… Documenta la estructura en el `description` del campo

---

## ğŸš€ Comandos RÃ¡pidos

```bash
# Desarrollo
cd visualPlayground
pnpm install        # Primera vez
pnpm dev           # Frontend (puerto 5173)
pnpm run server    # Backend (puerto 3001)

# Scripts
pnpm run scripts/convertSpells.ts   # conjuros.json â†’ allSpells.ts
pnpm run scripts/importSpells.ts    # allSpells.ts â†’ server/data/

# Limpieza
rm -rf server/data/entities/spell   # Limpiar conjuros
rm -rf node_modules && pnpm install # Reinstalar dependencias
```

---

## ğŸ“– DocumentaciÃ³n Relacionada

- [Sistema de Entidades Core](../core/domain/entities/README.md)
- [Entity Management PRD](../core/domain/entities/EntityManagement.prd.md)
- [Roadmap de Entidades](../core/domain/entities/roadmap/README.md)
